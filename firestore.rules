rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // 헬퍼 함수: 현재 사용자 확인
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // 헬퍼 함수: 어드민 여부 확인
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/admins/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // 헬퍼 함수: 자신의 데이터인지 확인
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // 헬퍼 함수: 매칭된 사용자인지 확인
    function isMatched(otherUserId) {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/matches/$(getMatchId(request.auth.uid, otherUserId)));
    }
    
    // 매칭 ID 생성 (정렬된 사용자 ID 조합)
    function getMatchId(userId1, userId2) {
      let ids = [userId1, userId2];
      return ids.sort().join('_');
    }
    
    // 어드민 컬렉션: 어드민만 읽기/쓰기 가능
    match /admins/{adminId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // 프로필: 모든 인증 사용자가 읽기 가능, 자신의 프로필만 쓰기 가능 (어드민은 모든 권한)
    match /profiles/{userId} {
      allow read: if isAuthenticated() || isAdmin();
      allow create: if isOwner(userId) || isAdmin();
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    // 좋아요: 모든 인증 사용자가 읽기/쓰기 가능 (자신이 보낸 좋아요만)
    match /likes/{likeId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
        request.resource.data.fromUserId == request.auth.uid;
      allow update, delete: if isAuthenticated() && 
        resource.data.fromUserId == request.auth.uid;
    }
    
    // 매칭: 참여자만 읽기 가능, 생성은 인증된 사용자만
    match /matches/{matchId} {
      allow read: if isAuthenticated() && 
        request.auth.uid in resource.data.participantIds;
      allow create: if isAuthenticated() && 
        request.auth.uid in request.resource.data.participantIds;
      allow update: if isAuthenticated() && 
        request.auth.uid in resource.data.participantIds;
      allow delete: if false; // 매칭은 삭제 불가
    }
    
    // 채팅방: 참여자만 읽기/쓰기 가능
    match /chatRooms/{roomId} {
      allow read: if isAuthenticated() && 
        request.auth.uid in resource.data.participantIds;
      allow create: if isAuthenticated() && 
        request.auth.uid in request.resource.data.participantIds;
      allow update: if isAuthenticated() && 
        request.auth.uid in resource.data.participantIds;
      allow delete: if false; // 채팅방은 삭제 불가
    }
    
    // 메시지: 채팅방 참여자만 읽기/쓰기 가능
    match /messages/{messageId} {
      // 채팅방 참여자인지 확인
      function isChatParticipant() {
        let chatId = resource.data.chatId;
        let room = get(/databases/$(database)/documents/chatRooms/$(chatId));
        return request.auth.uid in room.data.participantIds;
      }
      
      allow read: if isAuthenticated() && isChatParticipant();
      allow create: if isAuthenticated() && 
        request.resource.data.senderId == request.auth.uid &&
        isChatParticipant();
      allow update: if isAuthenticated() && 
        resource.data.senderId == request.auth.uid;
      allow delete: if false; // 메시지는 삭제 불가
    }
    
    // 알림: 자신의 알림만 읽기 가능
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    function restrictedFieldUnchanged(field) {
      return !(field in request.resource.data) ||
        (resource != null && field in resource.data && request.resource.data[field] == resource.data[field]);
    }

    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if (isOwner(userId) &&
        !("coinBalance" in request.resource.data) &&
        !("freeSwipeCount" in request.resource.data) &&
        !("subscription" in request.resource.data)) || isAdmin();
      allow update: if (isOwner(userId) &&
        restrictedFieldUnchanged('coinBalance') &&
        restrictedFieldUnchanged('freeSwipeCount') &&
        restrictedFieldUnchanged('subscription')) || isAdmin();
      allow delete: if isOwner(userId) || isAdmin();
    }

    match /coin_purchases/{purchaseId} {
      allow read: if (isAuthenticated() && resource.data.uid == request.auth.uid) || isAdmin();
      allow write: if isAdmin();
    }

    match /coin_transactions/{transactionId} {
      allow read: if (isAuthenticated() && resource.data.uid == request.auth.uid) || isAdmin();
      allow write: if isAdmin();
    }

    match /actions/{actionId} {
      allow read: if (isAuthenticated() && resource.data.uid == request.auth.uid) || isAdmin();
      allow write: if isAdmin();
    }
    
    // 차단: 자신이 차단한 사용자만 읽기 가능, 자신이 차단한 것만 생성 가능
    match /blocks/{blockId} {
      allow read: if isAuthenticated() && 
        resource.data.blockerId == request.auth.uid;
      allow create: if isAuthenticated() && 
        request.resource.data.blockerId == request.auth.uid;
      allow delete: if isAuthenticated() && 
        resource.data.blockerId == request.auth.uid;
      allow update: if false; // 차단은 업데이트 불가
    }
    
    // 신고: 자신이 신고한 것만 읽기 가능, 모든 인증 사용자가 신고 가능, 어드민은 모든 권한
    match /reports/{reportId} {
      allow read: if (isAuthenticated() && 
        resource.data.reporterId == request.auth.uid) || isAdmin();
      allow create: if isAuthenticated() && 
        request.resource.data.reporterId == request.auth.uid;
      allow update: if isAdmin(); // 어드민만 신고 상태 업데이트 가능
      allow delete: if isAdmin(); // 어드민만 삭제 가능
    }
    
    // 슈퍼라이크: 자신이 보낸 슈퍼라이크만 읽기 가능, 자신이 보낸 것만 생성 가능
    match /superLikes/{superLikeId} {
      allow read: if isAuthenticated() && 
        resource.data.fromUserId == request.auth.uid;
      allow create: if isAuthenticated() && 
        request.resource.data.fromUserId == request.auth.uid;
      allow update, delete: if false; // 슈퍼라이크는 수정/삭제 불가
    }
    
    // 인증 요청: 자신의 인증 요청만 읽기 가능, 자신의 요청만 생성 가능, 어드민은 모든 권한
    match /verifications/{verificationId} {
      allow read: if (isAuthenticated() && 
        resource.data.userId == request.auth.uid) || isAdmin();
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin(); // 어드민만 인증 상태 업데이트 가능
      allow delete: if isAdmin(); // 어드민만 삭제 가능
    }
    
    // 기타 컬렉션은 기본적으로 거부
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

